var h=class extends Error{constructor(e){super(e),this.name="NFError"}},m=class extends h{constructor(e){super(e),this.name="NFDiscoveryError"}},y=(e,n)=>{try{let o=e.split("."),c=n.split(".");for(let i=0;i<Math.min(o.length,c.length);i++){if(Number(o[i])>Number(c[i]))return 1;if(Number(o[i])<Number(c[i]))return-1}}catch{return e.localeCompare(n)}return 0},S=e=>e.reduce((n,o)=>({...n,[o]:"latest"}),{}),b=e=>e.sort(y)[0],D=(e,n)=>e.filter(o=>y(o,n)<0).sort(y)[0],H=e=>{let n=r=>{if(r==="skip-cache"||!e.entry("discovery").exists())return!1;let t=e.fetch("discovery"),a={};r==="all-latest"&&(r=S(Object.keys(t)));for(let[s,l]of Object.entries(r)){if(!t[s]||Object.keys(t[s]).length===0)return!1;let u=l==="latest"?b(Object.keys(t[s])):l;if(!t[s][u])return!1;a[s]=t[s][u]}return a},o=r=>t=>((r==="all-latest"||Object.keys(r).length<1)&&(r=S(Object.keys(t))),Object.entries(r).reduce((a,[s,l])=>{if(!t[s]||t[s].length<1)throw new m(`Remote '${s}' is not available in discovery.`);let u=Object.values(t[s]).reduce((d,F)=>({...d,[F.metadata.version]:F}),{});if(l==="latest"&&(l=b(Object.keys(u))),!u[l]){console.warn(`Version '${l}' of remote '${s}' is not available in discovery.`);let d=D(Object.keys(u),l);if(!d)throw new m(`Remote '${s}' has no versions available before '${l}' in discovery.`);console.warn("Falling back to "+d),l=d}return{...a,[s]:u[l]}},{})),c=r=>(e.mutate("discovery",t=>(Object.entries(r).forEach(([a,s])=>{let l=s.metadata.version;t[a]||(t[a]={}),t[a][l]||(t[a][l]=s)}),t)),r);return{fetchRemoteConfigs:(r,t)=>{let a=n(t);return a?Promise.resolve(a):(t==="all-latest"&&(t={}),fetch(r).then(s=>s.json()).then(s=>s.microFrontends).then(o(t)).then(c))}}},O=e=>{let n=e.entry("discovery"),o=r=>b(Object.keys(r??{})),c=(r,t)=>t[r]?.metadata.version;return{getIfInitialized:(r,t,a)=>{let s=n.get()[t];if(!s||Object.keys(s).length<1)throw new m(`Remote '${t}' is not initialized.`);if(a||(a=c(t,r)??o(s)),!a)throw new m(`Remote '${t}' contains 0 initialized versions.`);let l=s[a];if(!l)throw new m(`Version '${a}' from remote '${t}' is not initialized.`);return{remoteName:t,remoteEntry:l.extras.nativefederation.remoteEntry,exposedModule:l.extras.nativefederation.exposedModule}}}};function R(e){let n=r=>e[r],o=r=>e[r].get();return{fetch:o,mutate:(r,t)=>{let a=t(o(r));return e[r].set(a),R(e)},get:()=>e,entry:n}}var $=(e,n)=>Object.entries(e).reduce((o,[c,i])=>({...o,[c]:n(c,i)}),{}),v="__NATIVE_FEDERATION__",I=(e,n)=>{globalThis[v]||(globalThis[v]={});let o=globalThis[v],c={get(){return o[e]??n},set(i){return o[e]=i,c},exists(){return e in o}};return c},P={externals:{},remoteNamesToRemote:{},baseUrlToRemoteNames:{}},L=$(P,I),_=()=>({createImportMap:o=>(document.head.appendChild(Object.assign(document.createElement("script"),{type:"importmap-shim",innerHTML:JSON.stringify(o)})),o),importModule:async o=>globalThis.importShim(o)}),C=e=>{let n=e.split("/");return n.pop(),n.join("/")},p=(e,n)=>(e=e.startsWith("/")?e.slice(1):e,n=n.endsWith("/")?n.slice(0,-1):n,`${e}/${n}`),U=e=>{let n=()=>({imports:{},scopes:{}}),o=t=>t.reduce((a,s)=>({imports:{...a.imports,...s.imports},scopes:{...a.scopes,...s.scopes}}),n()),c=(t,a)=>t.exposes.reduce((s,l)=>({...s,[p(a,l.key)]:p(t.baseUrl,l.outFileName)}),{}),i=t=>({[t.baseUrl+"/"]:e.mapSharedDeps(t)});return{toImportMap:(t,a)=>(a||(a=t.name),{imports:c(t,a),scopes:i(t)}),createEmpty:n,merge:o}},A=(e,n)=>{let o=r=>fetch(r).then(t=>t.json()).then(t=>({...t,baseUrl:C(r)})),c=(r,t)=>(e.mutate("remoteNamesToRemote",a=>({...a,[t]:r})),e.mutate("baseUrlToRemoteNames",a=>({...a,[r.baseUrl]:t})),r);return{loadRemoteInfo:(r,t)=>{if(!t&&r&&(t=e.fetch("baseUrlToRemoteNames")[C(r)]),!t)return Promise.reject("Must provide valid remoteEntry or remoteName");let a=e.fetch("remoteNamesToRemote")[t];return a?Promise.resolve(a):r?o(r).then(s=>c(s,t??s.name)).then(n.addSharedDepsToCache):Promise.reject(`Module not registered, provide a valid remoteEntryUrl for '${t}'`)}}},g=e=>`${e.packageName}@${e.version}`,V=e=>{let n=r=>e.fetch("externals")[g(r)],o=r=>r.shared.reduce((t,a)=>({...t,[a.packageName]:n(a)||p(r.baseUrl,a.outFileName)}),{}),c=r=>t=>r.shared.reduce((a,s)=>(a[g(s)]||(a[g(s)]=p(r.baseUrl,s.outFileName)),a),t);return{mapSharedDeps:o,addSharedDepsToCache:r=>(e.mutate("externals",c(r)),r)}},k=({cache:e})=>{let n=R(e),o=V(n),c=A(n,o),i=U(o),r=_();return{cacheHandler:n,sharedInfoHandler:o,remoteInfoHandler:c,importMapHandler:i,domHandler:r}},z=e=>({cache:e.cache??{...L,...$({discovery:{}},I)},resolveFromCache:e.resolveFromCache??"all-latest"}),J=e=>{let{cacheHandler:n,remoteInfoHandler:o,domHandler:c,importMapHandler:i}=k(e),r=H(n),t=O(n);return{cacheHandler:n,remoteInfoHandler:o,importMapHandler:i,domHandler:c,discoveryHandler:r,remoteModuleHandler:t}},W=(e,n)=>{let o=(r,t)=>{if(typeof r=="string"&&t)return{remoteName:r,exposedModule:t};if(typeof r=="object"&&!t)return r;throw new h("unexpected arguments: please pass options or a remoteName/exposedModule-pair")},c=(r,t)=>{let a=r.exposes.find(s=>s.key===t);if(!a)throw new h(`Unknown exposed module ${t} in remote ${r.name}`);return p(r.baseUrl,a.outFileName)};return{load:(r,t)=>{let a=o(r,t);if(!a.remoteName||a.remoteName==="")throw new h("remoteName cannot be empty");return e.loadRemoteInfo(a.remoteEntry,a.remoteName).then(s=>c(s,a.exposedModule)).then(n.importModule)}}},G=(e,n,o)=>{let c=W(e,o),i=(s={})=>typeof s=="string"?fetch(s).then(l=>l.json()):Promise.resolve(s),r=([s,l])=>e.loadRemoteInfo(l,s).then(u=>n.toImportMap(u,s)).catch(u=>(console.warn(`Error loading remoteEntry for ${s} at '${l}', skipping module`),n.createEmpty())),t=s=>Promise.all(Object.entries(s).map(r)).then(n.merge);return{init:(s={})=>i(s).then(t).then(o.createImportMap).then(l=>({importMap:l,load:c.load}))}},q=(e,n,o)=>{let c=t=>Object.keys(t).reduce((a,s)=>{if(!t[s])throw new m(`Could not preload remote '${s}', not available in discovery.`);return{...a,[s]:t[s].extras.nativefederation.remoteEntry}},{}),i=(t,a)=>(s,l)=>{let u=n.getIfInitialized(a,s,l);return t(u)};return{init:(t,a)=>e.fetchRemoteConfigs(t,a).then(s=>{let l=c(s);return o.init(l).then(({load:u,importMap:d})=>({load:i(u,s),importMap:d,discovery:s}))})}},j=(e,n={})=>{let o=z(n),{remoteInfoHandler:c,importMapHandler:i,domHandler:r,discoveryHandler:t,remoteModuleHandler:a}=J(o);return q(t,a,G(c,i,r)).init(e,o.resolveFromCache)};var K=(e,n)=>Object.entries(e).reduce((o,[c,i])=>({...o,[c]:n(c,i)}),{}),E="__NATIVE_FEDERATION__",Q=(e,n)=>{let o={get(){let c=sessionStorage.getItem(`${E}.${e}`)??JSON.stringify(n);return JSON.parse(c)},set(c){let i=typeof c=="string"?c:JSON.stringify(c);return sessionStorage.setItem(`${E}.${e}`,i),o},exists(){return!!sessionStorage.getItem(`${E}.${e}`)}};return o},N=e=>K(e,Q);var X=Object.defineProperty,Y=(e,n)=>{for(var o in n)X(e,o,{get:n[o],enumerable:!0})};function w(e){let n=r=>e[r],o=r=>e[r].get();return{fetch:o,mutate:(r,t)=>{let a=t(o(r));return e[r].set(a),w(e)},get:()=>e,entry:n}}var M=(e,n)=>Object.entries(e).reduce((o,[c,i])=>({...o,[c]:n(c,i)}),{}),f="__NATIVE_FEDERATION__",x=(e,n)=>{globalThis[f]||(globalThis[f]={});let o=globalThis[f],c={get(){return o[e]??n},set(i){return o[e]=i,c},exists(){return e in o}};return c},Z=e=>M(e,x),B={externals:{},remoteNamesToRemote:{},baseUrlToRemoteNames:{}},ee=M(B,x);var T={};Y(T,{DEFAULT_CACHE:()=>ee,NAMESPACE:()=>f,cacheHandlerFactory:()=>w,createGlobalCache:()=>Z,toCache:()=>M});(()=>{let e={...T.DEFAULT_CACHE,...N({discovery:{}})};j("http://localhost:3000",{cache:e}).then(({load:n,discovery:o,importMap:c})=>{console.log("discovery: ",o),console.log("importMap: ",c),window.dispatchEvent(new CustomEvent("mfe-loader-available",{detail:{load:n}}))})})();
//# sourceMappingURL=loader-with-discovery.js.map
